
# [Platinum I] Hierarchical Structure - 16587

[문제 링크](https://www.acmicpc.net/problem/16587)

### 문제 요약

<p> $N$개의 정점으로 이루어진 트리와 $Q$개의 경로 쿼리가 주어진다. 각 쿼리에 대해 올바른 답을 출력해보자. </p>

### 제한

TL : 3sec, ML : 512 MB

$1 ≤ N ≤ 100,000$

$1 ≤ Q ≤ 100,000$

$1 ≤ A_i ≤ 10^9$

### 성능 요약

메모리: 70456 KB, 시간: 616 ms

### 분류

자료구조(data_structures), 트리(trees), Heavy-light 분할(heavy-light decomposition), 세그먼트 트리(segtree), 머지 소트 트리(merge sort tree), 
정렬(sorting), 누적 합(prefix sum), 이분 탐색(binary search)

### comment

오랜만에 재밌는 hld 문제를 풀어 보았다.

최대 10만 개의 쿼리가 주어지고 서로 다른 두 정점의 경로 상 쿼리를 처리해야 한다.

이를 효율적으로 처리하기 위하여 우선 hld 이용해 트리를 분할하자.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

쿼리 내용을 보면 다음으로 생각할 수 있다.

* 두 정점을 잇는 경로 위 정점들의 가중치를 $x_i$라 할 때, $l ≤ x_i ≤ r$인 $Σx_i$ 을 구하여라.

기껏 hld를 짜놓고 하나하나 더해보는 미련한 짓은 할 수 없다.

만약 경로 위 정점들의 가중치들을 모두 정렬된 상태로 갖고 있다면, 이분 탐색을 이용해 $l, r$의 인덱스를 찾아낼 수 있다.

또, 이 사이의 연속합을 구해야 하므로 누적 합을 써먹을 수도 있을 것 같다.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

처음 주어지는 $A_i$들을 머지 소트 트리 (이하 $seg$) 위에 모두 올리자.

이후 $seg$의 모든 노드들을 정렬하며 동시에 같은 노드 번호를 갖는 누적합 트리( $pseg$ )도 전처리 해주자.

그럼 결국 $l ≤ x_i ≤ r$인 $x$의 인덱스를 $seg$ 위에서 이분 탐색으로 찾고, 그 사이 합을 $pseg$ 를 이용해 $O(1)$로 구하면

위에서 정리한 내용대로 전처리에 약 $O(logN * (N * log N + N))$, 쿼리당 $O((logN)^3)$의 복잡도로  수 있다 !

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------

이 문제를 시도하는 사람들이라면 hld에서 쿼리를 날리는 방법은 당연히 알고 있을테니 이외 설명은 생략하겠다.

.

hld + 가장 기본적인 세그를 이용한 쿼리 처리가 p1인데, 이 정도면 한 단계 높아도 되지 않나 싶다.

아직 푼 사람이 별로 없어 기여가 적어서 그런가..
